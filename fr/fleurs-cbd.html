<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Flux concurrent (cbd.fr) — Fleurs CBD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 2rem; }
    h1 { margin: 0 0 1rem; font-size: 1.5rem; }
    .row { display: grid; grid-template-columns: 1fr auto auto; gap: .5rem 1rem; align-items: center; padding: .5rem 0; border-bottom: 1px solid #eee; }
    .row a { text-decoration: none; }
    .bad { color: #a00; }
    .muted { color: #666; font-size: .9em; }
    .controls { display: flex; gap: .5rem; flex-wrap: wrap; margin: .5rem 0 1rem; }
    input, select, button { padding: .5rem .6rem; }
    .pill { border: 1px solid #ddd; border-radius: 999px; padding: .2rem .6rem; font-size: .85em; }
    #status { margin:.5rem 0 1rem; }
    #list { border-top: 1px solid #eee; }
  </style>
</head>
<body>
  <h1>Flux concurrent — cbd.fr</h1>
  <p class="muted">
    Ce widget récupère les dernières URLs produits / catégories depuis les <b>sitemaps</b> de cbd.fr et les affiche comme un flux léger.
  </p>

  <div class="controls">
    <label>Filtre URL: <input id="q" placeholder="ex: /78fleurs-de-cbd ou /s/" /></label>
    <label>Tri:
      <select id="sort">
        <option value="date_desc">Date (récent → ancien)</option>
        <option value="date_asc">Date (ancien → récent)</option>
        <option value="url_asc">URL (A → Z)</option>
        <option value="url_desc">URL (Z → A)</option>
      </select>
    </label>
    <button id="refresh">Rafraîchir</button>
    <span class="pill">Source: sitemaps cbd.fr</span>
  </div>

  <div id="status" class="muted">Chargement…</div>
  <div id="list" role="list"></div>

  <script>
    // --- Réglages ---
    const DOMAIN = "https://www.cbd.fr";
    // Endpoints candidats repérés sur cbd.fr
    const SITEMAP_CANDIDATES = [
      "/sitemap.xml",
      "/sitemap_index.xml",
      "/as4_seositemap-1.xml",   // catégories/produits (module SEO)
      "/as4_seositemap-2.xml",
      "/as4_seositemap-3.xml",
      "/as4_seositemap-10.xml",
      "/as4_seositemap-15.xml"
    ];

    // Proxy CORS gratuit (remplacez par le vôtre en prod)
    const CORS = "https://api.allorigins.win/raw?url=";

    const $status = document.getElementById("status");
    const $list   = document.getElementById("list");
    const $q      = document.getElementById("q");
    const $sort   = document.getElementById("sort");
    const $refresh= document.getElementById("refresh");

    // Heuristique: on ne garde que des URLs "intéressantes" (produits / catégories / contenus)
    function isInteresting(url) {
      const u = url.toLowerCase();
      return (
        u.includes("/products/") ||
        u.includes("/product/")  ||
        u.includes("/produit")   ||
        u.includes("/s/")        ||  // pages marketing sur cbd.fr
        u.includes("/78fleurs-de-cbd") ||
        u.includes("/84huiles-de-cbd") ||
        u.includes("/gélules") || u.includes("/gelules") ||
        u.includes("/hash") || u.includes("/resines") ||
        u.includes("/fleurs") ||
        u.includes("/blog")
      );
    }

    async function fetchText(url) {
      const proxied = CORS + encodeURIComponent(url);
      const r = await fetch(proxied, { headers: { "Accept": "text/*" }});
      if (!r.ok) throw new Error("HTTP " + r.status);
      return await r.text();
    }

    function parseXml(xmlString) {
      return new window.DOMParser().parseFromString(xmlString, "application/xml");
    }

    function extractFromUrlset(doc) {
      // <urlset><url><loc>…</loc><lastmod>…</lastmod></url></urlset>
      const out = [];
      doc.querySelectorAll("urlset > url").forEach(node => {
        const loc = node.querySelector("loc")?.textContent?.trim();
        if (!loc) return;
        if (!isInteresting(loc)) return;
        const lastmod = node.querySelector("lastmod")?.textContent?.trim() || null;
        out.push({ url: loc, lastmod });
      });
      return out;
    }

    function extractFromSitemapIndex(doc) {
      // <sitemapindex><sitemap><loc>…</loc></sitemap>…
      const urls = [];
      doc.querySelectorAll("sitemapindex > sitemap > loc").forEach(n => {
        const loc = n.textContent.trim();
        urls.push(loc);
      });
      return urls;
    }

    async function fetchOneSitemap(url) {
      try {
        const xml = await fetchText(url);
        const doc = parseXml(xml);

        // Erreurs XML ?
        const parserError = doc.querySelector("parsererror");
        if (parserError) throw new Error("XML invalide");

        // sitemap index ?
        if (doc.querySelector("sitemapindex")) {
          const children = extractFromSitemapIndex(doc);
          let items = [];
          for (const sm of children) {
            try {
              const childXml = await fetchText(sm);
              const childDoc = parseXml(childXml);
              items = items.concat(extractFromUrlset(childDoc));
            } catch (_e) {
              // ignore un sous-sitemap en erreur
            }
          }
          return items;
        }

        // urlset classique
        if (doc.querySelector("urlset")) {
          return extractFromUrlset(doc);
        }

        return [];
      } catch (e) {
        return [];
      }
    }

    function dedupe(items) {
      const seen = new Set();
      const out = [];
      for (const it of items) {
        const key = it.url;
        if (seen.has(key)) continue;
        seen.add(key);
        out.push(it);
      }
      return out;
    }

    function render(items) {
      $list.innerHTML = "";
      if (!items.length) {
        $list.innerHTML = `<div class="bad">Aucun item trouvé.</div>`;
        return;
      }
      for (const it of items) {
        const row = document.createElement("div");
        row.className = "row";
        const a = document.createElement("a");
        a.href = it.url;
        a.target = "_blank";
        a.rel = "noopener";
        a.textContent = it.url.replace(/^https?:\/\/(www\.)?/, "");
        const d = document.createElement("div");
        d.className = "muted";
        d.textContent = it.lastmod ? new Date(it.lastmod).toLocaleString() : "—";
        const host = document.createElement("div");
        host.className = "muted";
        try {
          host.textContent = new URL(it.url).pathname;
        } catch (_) {
          host.textContent = "";
        }
        row.appendChild(a);
        row.appendChild(d);
        row.appendChild(host);
        $list.appendChild(row);
      }
    }

    function applyFilters(items) {
      const q = ($q.value || "").toLowerCase().trim();
      let filtered = items;
      if (q) {
        filtered = filtered.filter(it => it.url.toLowerCase().includes(q));
      }
      const mode = $sort.value;
      filtered = filtered.slice();
      if (mode === "date_desc") filtered.sort((a,b)=>(b.lastmod||"") > (a.lastmod||"") ? 1 : -1);
      if (mode === "date_asc")  filtered.sort((a,b)=>(a.lastmod||"") > (b.lastmod||"") ? 1 : -1);
      if (mode === "url_asc")   filtered.sort((a,b)=>a.url.localeCompare(b.url));
      if (mode === "url_desc")  filtered.sort((a,b)=>b.url.localeCompare(a.url));
      return filtered;
    }

    async function load() {
      $status.textContent = "Chargement des sitemaps de cbd.fr…";
      let all = [];
      // 1) On tente les sitemaps candidats directs
      for (const path of SITEMAP_CANDIDATES) {
        const url = DOMAIN + path;
        const items = await fetchOneSitemap(url);
        if (items.length) {
          all = all.concat(items);
        }
      }
      // 2) Si /sitemap.xml contient un index, il sera déjà suivi par fetchOneSitemap()

      all = dedupe(all);

      $status.textContent = `Trouvés: ${all.length} items (avant filtre).`;

      const renderNow = () => render(applyFilters(all));
      renderNow();

      $q.addEventListener("input", renderNow);
      $sort.addEventListener("change", renderNow);
      $refresh.addEventListener("click", () => load()); // recharger au besoin
    }

    load();
  </script>

  <p class="muted" style="margin-top:2rem">
    ⚖️ Respectez les <a href="https://www.cbd.fr/conditions-d-utilisation" target="_blank" rel="noopener">conditions d’utilisation</a> et robots.txt du site concurrent. Ce widget n’extrait que des URLs publiques listées dans les sitemaps.
  </p>
</body>
</html>
