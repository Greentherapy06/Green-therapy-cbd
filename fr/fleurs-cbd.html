<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>fleurs CBD â€“ Veille Concurrents | Green-Therapy</title>
  <meta name="description" content="Veille automatique des concurrents Fleurs CBD : derniers articles et mises Ã  jour agrÃ©gÃ©s depuis leurs flux RSS/Atom.">
  <meta name="robots" content="index, follow">
  <meta name="author" content="Green-Therapy">
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />

  <!-- PrÃ©connexions (perf) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://cdn.snipcart.com" crossorigin>
  <link rel="preconnect" href="https://api.allorigins.win" crossorigin>

  <!-- CSS principal du site -->
  <link rel="stylesheet" href="../style.css" />

  <style>
    /* Garde lâ€™image dâ€™en-tÃªte du site */
    header{ background:url('../images.webp') no-repeat center center/cover; }

    /* Petite grille propre pour les cartes actu */
    .feed-wrap{ max-width:1000px; margin:24px auto; padding:0 16px; }
    .feed-toolbar{ display:flex; gap:.75rem; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .feed-toolbar small{ opacity:.8; }
    .feed-grid{ display:grid; grid-template-columns:1fr; gap:14px; margin-top:14px; }
    @media (min-width:720px){ .feed-grid{ grid-template-columns:1fr 1fr; } }
    .feed-card{
      border:1px solid #eee; border-radius:14px; padding:14px 16px; background:#fff;
      box-shadow:0 1px 2px rgba(0,0,0,.03);
    }
    .feed-card h3{ font-size:1.05rem; margin:0 0 .35rem; line-height:1.35; }
    .feed-meta{ font-size:.9rem; opacity:.85; display:flex; gap:.5rem; flex-wrap:wrap; }
    .badge{ font-size:.75rem; border:1px solid #e6e6e6; padding:2px 8px; border-radius:999px; white-space:nowrap; }
    .feed-actions{ display:flex; gap:.5rem; margin-top:.5rem; }
    .btn{ border:1px solid #000; background:#000; color:#d4af37; padding:6px 10px; border-radius:8px; cursor:pointer; }
    .btn.secondary{ background:#fff; color:#000; }
    .empty{ text-align:center; opacity:.8; padding:18px 8px; }
    .spinner{ width:22px; height:22px; border:3px solid #e9e9e9; border-top:3px solid #000; border-radius:50%; animation:spin 1s linear infinite; display:inline-block; vertical-align:middle; }
    @keyframes spin{ to{ transform:rotate(360deg);} }

    /* Perf dâ€™affichage paresseux */
    #feed{ content-visibility:auto; contain-intrinsic-size:800px; }
  </style>
</head>
<body>
  <!-- Header (identique au site) -->
  <header>
    <div class="logo-container">
      <img src="../logo-rond.png" alt="Logo Green-Therapy - CBD Premium" class="logo" loading="lazy" width="80" height="80" />
      <h1>Green-Therapy</h1>
    </div>
    <nav>
      <a href="./index.html#home"> Accueil</a>
      <a href="./index.html#produits"> Produits</a>
      <a href="./index.html#contact"> Contact</a>
      <a href="/fr/" hreflang="fr">ðŸ‡¨ðŸ‡µ FranÃ§ais</a>
    </nav>
  </header>

  <section class="section">
    <div class="feed-wrap" id="feed">
      <h2>ðŸ“° Veille â€“ Fleurs CBD (concurrents)</h2>
      <div class="feed-toolbar">
        <small id="lastUpdate">Chargement des fluxâ€¦ <span class="spinner" aria-hidden="true"></span></small>
        <div>
          <button class="btn secondary" id="btnRefresh" type="button">RafraÃ®chir</button>
          <button class="btn secondary" id="btnClear" type="button">Vider le cache</button>
        </div>
      </div>

      <div id="feedGrid" class="feed-grid" aria-live="polite"></div>
      <div id="feedEmpty" class="empty" hidden>Aucune actualitÃ© trouvÃ©e pour lâ€™instant.</div>
    </div>
  </section>

  <footer style="text-align:center; padding:20px; font-size:14px;">
    <a href="./mentions-legales.html">Mentions lÃ©gales</a> |
    <a href="./politique-confidentialite.html">Politique de confidentialitÃ©</a> |
    <a href="./cookies.html">Cookies</a> |
    <a href="./cgv.html">CGV</a>
  </footer>

  <script>
    // 1) RENSEIGNE ICI les flux de tes concurrents (RSS/Atom)
    //    Exemple : "https://exemple.com/feed", "https://exemple.com/rss.xml"
    const COMPETITOR_FEEDS = [
      { name: "Concurrent A", url: "https://exemple-a.com/feed" },
      { name: "Concurrent B", url: "https://exemple-b.com/rss.xml" },
      { name: "Concurrent C", url: "https://exemple-c.com/feed" }
    ];
    const ITEMS_PER_SOURCE = 6;         // nombre dâ€™articles par source
    const CACHE_TTL_MINUTES = 15;       // durÃ©e de cache (LocalStorage)

    const $grid = document.getElementById('feedGrid');
    const $empty = document.getElementById('feedEmpty');
    const $last = document.getElementById('lastUpdate');
    const $btnRefresh = document.getElementById('btnRefresh');
    const $btnClear = document.getElementById('btnClear');

    const CACHE_KEY = 'gt_feed_cache_v1';

    function fmtDate(d){
      try{
        return new Intl.DateTimeFormat('fr-FR', { dateStyle:'medium', timeStyle:'short' }).format(d);
      }catch(e){ return d.toLocaleString(); }
    }

    function getFromCache(){
      try{
        const raw = localStorage.getItem(CACHE_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!obj || !obj.time || !obj.items) return null;
        const ageMin = (Date.now() - obj.time) / 60000;
        if(ageMin > CACHE_TTL_MINUTES) return null;
        return obj;
      }catch(e){ return null; }
    }
    function saveToCache(items){
      try{
        localStorage.setItem(CACHE_KEY, JSON.stringify({ time: Date.now(), items }));
      }catch(e){}
    }

    async function fetchViaAllOrigins(url){
      const api = 'https://api.allorigins.win/get?url=' + encodeURIComponent(url);
      const res = await fetch(api);
      if(!res.ok) throw new Error('Erreur rÃ©seau ' + res.status);
      const data = await res.json();
      return data.contents;
    }

    function parseFeed(xmlString, sourceName){
      const out = [];
      const doc = new DOMParser().parseFromString(xmlString, 'text/xml');

      // Essaye RSS <item>, sinon Atom <entry>
      let nodes = [...doc.querySelectorAll('item')];
      if(nodes.length === 0) nodes = [...doc.querySelectorAll('entry')];

      for(const node of nodes.slice(0, ITEMS_PER_SOURCE)){
        const get = sel => (node.querySelector(sel) ? node.querySelector(sel).textContent.trim() : '');
        const title = get('title') || '(Sans titre)';
        let link = get('link');
        // Atom peut imbriquer <link href="...">
        if(!link){
          const l = node.querySelector('link[href]');
          if(l) link = l.getAttribute('href') || '';
        }
        const dateStr = get('pubDate') || get('updated') || get('published') || get('dc\\:date') || get('date');
        const date = dateStr ? new Date(dateStr) : new Date(0);

        out.push({
          title,
          link,
          date,
          source: sourceName
        });
      }
      return out;
    }

    function render(items){
      $grid.innerHTML = '';
      if(!items || items.length === 0){
        $empty.hidden = false;
        return;
      }
      $empty.hidden = true;

      // Trie par date dÃ©croissante
      items.sort((a,b) => b.date - a.date);

      for(const it of items){
        const card = document.createElement('article');
        card.className = 'feed-card';
        card.innerHTML = `
          <h3><a href="${it.link}" target="_blank" rel="noopener nofollow">${escapeHtml(it.title)}</a></h3>
          <div class="feed-meta">
            <span class="badge">${escapeHtml(it.source)}</span>
            <time datetime="${it.date.toISOString()}">${fmtDate(it.date)}</time>
          </div>
          <div class="feed-actions">
            <a class="btn secondary" href="${it.link}" target="_blank" rel="noopener nofollow">Ouvrir</a>
          </div>
        `;
        $grid.appendChild(card);
      }
      $last.textContent = 'DerniÃ¨re mise Ã  jour : ' + fmtDate(new Date());
    }

    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    async function loadFeeds({force=false} = {}){
      if(!force){
        const cached = getFromCache();
        if(cached){ render(cached.items.map(x => ({...x, date:new Date(x.date)}))); return; }
      }

      $last.innerHTML = 'Chargement des fluxâ€¦ <span class="spinner" aria-hidden="true"></span>';
      const allItems = [];

      for(const feed of COMPETITOR_FEEDS){
        try{
          const xml = await fetchViaAllOrigins(feed.url);
          const items = parseFeed(xml, feed.name);
          allItems.push(...items);
        }catch(err){
          console.warn('Flux en erreur:', feed.url, err);
        }
      }

      saveToCache(allItems);
      render(allItems);
    }

    $btnRefresh.addEventListener('click', () => loadFeeds({force:true}));
    $btnClear.addEventListener('click', () => { localStorage.removeItem(CACHE_KEY); loadFeeds({force:true}); });

    // DÃ©marrage
    loadFeeds();
  </script>
</body>
  </html>
